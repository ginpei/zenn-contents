---
title: "Agoraã§å›ã ã‘ã®æœ€å¼·ã®Clubhouseã‚’ä½œã‚ã†"
emoji: "ğŸ£"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["agora", "webrtc", "javascript"]
published: true
---

**Clubhouse ã«æ‹›å¾…ã•ã‚Œãªã„ã®ã§è‡ªåˆ†ã§ä½œã£ã¦ã¿ãŸ**ã€ã¿ãŸã„ãªæ„Ÿã˜ã§ã™ã€‚ã¾ã‚åˆ¥ã«æ‹›å¾…ã—ã¦ãã‚Œãªãã¦ã„ã„ã‚“ã§ã™ã‘ã©ã­ã€å¤§ã—ã¦èˆˆå‘³ãªã„ã—ãã®ã†ã¡ã‚ªãƒ¼ãƒ—ãƒ³ã«ãªã‚‹ã ã‚ã†ã—ãã‚Œã«ã»ã‚‰ã©ã†ã› Android ä½¿ã£ã¦ã‚‹ã—ã‚ã®ã¶ã©ã†ã¯é…¸ã£ã±ã„ã—^[[ã™ã£ã±ã„è‘¡è„ - Wikipedia](https://ja.wikipedia.org/wiki/%E3%81%99%E3%81%A3%E3%81%B1%E3%81%84%E8%91%A1%E8%90%84)]ã€‚

åˆæŒ‘æˆ¦ã§é ‘å¼µã£ã¦èª¿ã¹ã¦æ›¸ã„ã¦ã‚‹æ„Ÿã˜ãªã®ã§ä½•ã‹ã‚ã‚Œã° PR ã¨ã‹ãŠé¡˜ã„ã—ã¾ã™ã€‚

## å…ˆã«ã¾ã¨ã‚

- Clubhouse ã¯ Agora ã‚’ä½¿ã£ã¦ã„ã‚‹ã‚‰ã—ã„
- Agora - Real-Time Voice and Video Engagement
   -  https://www.agora.io/en/
- ç„¡æ–™æ ã¯éŸ³å£° 10,000 åˆ†/æœˆ
  - ï¼ˆèª¤ã£ã¦ã€10,000 æ™‚é–“/æœˆã€ã¨è¨˜è¼‰ã—ã¦ã¾ã—ãŸã€‚åˆ†ã§ã™ã€‚ã™ã¿ã¾ã›ã‚“ã§ã—ãŸã€‚ï¼‰
- å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ï¼š[Start a Voice Call](https://docs.agora.io/en/Voice/start_call_audio_web_ng?platform=Web#5-leave-the-channel)
- ä»Šå›ä½œã£ãŸãƒ‡ãƒ¢ï¼š[ginpei/try-agora](https://github.com/ginpei/try-agora)

![](https://storage.googleapis.com/zenn-user-upload/jyl8xt5kufepxa47jn7vlt5y858e)
*æ¯æœˆ 10,000 åˆ†ç„¡æ–™ã¨ã®ã“ã¨ã€‚[ä¾¡æ ¼ã®ãƒšãƒ¼ã‚¸ã‚ˆã‚Š](https://www.agora.io/en/pricing/)*

![](https://storage.googleapis.com/zenn-user-upload/ssyjh3kx1rbq4i7bjdsczgpw162w)
*ãƒ‡ãƒ¢ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã€‚é–‹å§‹ãƒœã‚¿ãƒ³ã‚„å‚åŠ è€…ã® ID ä¸€è¦§ãªã©*

## Agora?

- https://www.agora.io/en/

éŸ³å£°ã‚„æ˜ åƒã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚’è¡Œã† API ã‚’æä¾›ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã€‚å¾“é‡èª²é‡‘åˆ¶ã ã‘ã©[éŸ³å£° 10,000 åˆ†/æœˆã®ç„¡æ–™æ ](https://www.agora.io/en/pricing/)ãŒã‚ã‚Šã€ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ç™»éŒ²ç­‰ãªã—ã§æ°—è»½ã«è©¦ã›ã¾ã—ãŸã€‚ã¡ãªã¿ã« 10,000 åˆ† â‰’ 7æ—¥ã§ã™ã€‚è±ªå‹¢ã ã€‚

ã‚¦ã‚§ãƒ–ç‰ˆã® SDK ã¯ CDN ã‹ `npm install agora-rtc-sdk-ng` ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚TypeScript ã§ä½¿ãˆã‚‹å‹æƒ…å ±ã‚‚ãã£ã¡ã‚Šæä¾›ã•ã‚Œã¦ã„ã¦å¬‰ã—ã„ã€‚ä»–ã«ã‚‚ iOSã€Android ã¯ã‚‚ã¡ã‚ã‚“ Unity ã‚„ Flutterã€React Nativeç­‰ã€…å¹…åºƒãæä¾›ã•ã‚Œã¦ã¾ã™ã€‚

ãã—ã¦å™‚ã® Clubhouse ã¯ã“ã‚Œã‚’ä½¿ã£ã¦é‹å–¶ã•ã‚Œã¦ã„ã‚‹ã‚‰ã—ã„ã€‚

https://zenn.dev/voluntas/scraps/9403b803320d6f

> - åˆ©ç”¨ã—ã¦ã„ã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é…ä¿¡ã‚µãƒ¼ãƒ“ã‚¹ã¯ Agora.io
>   - DNS è¦‹ãŸã ã‘
>   - ap-japan.agora.io ãŒè¦‹ãˆãŸ

## ãƒ‡ãƒ¢ã‚’è©¦ã™

ã“ã‚Œã‹ã‚‰ä½œã‚Šæ–¹ã‚’ç´¹ä»‹ã™ã‚‹ã‚“ã ã‘ã©ã€ã§ãã‚ãŒã‚Šã¯ GitHub ã§å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚ï¼ˆãƒ©ã‚¤ãƒ–ãƒ‡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“ã™ã¿ã¾ã›ã‚“ã€‚ï¼‰

- [ginpei/try-agora](https://github.com/ginpei/try-agora)
  - å®Ÿè£…ã¯ `public/main.js` ã® `main()` ã‹ã‚‰
  - æœ¬è³ªçš„ã§ãªã„ UI æ“ä½œã¨ã‹ã®å®Ÿè£…ã¯ `ui.js`

è©¦ã™ã«ã¯ `git clone` ã®å¾Œ `public/secrets.example.js` ã‚’ `public/secrets.js` ã¸è¤‡è£½ã—ã€è¨­å®šã‚’ã—ã¦ãã ã•ã„ã€‚Agora ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç­‰ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

å‹é”ã¨ä¼šè©±ã‚’è©¦ã™å ´åˆã€[ngrok](https://ngrok.com/) ã‚’ä½¿ã£ã¦ localhost ã‚’å¤–éƒ¨ã¸ç¹‹ã’ã‚‹ã®ã‚’ `npm run serve:proxy` ã§æä¾›ã—ã¦ã„ã¾ã™ã€‚

![ãƒ‡ãƒ¢ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã€‚é–‹å§‹ãƒœã‚¿ãƒ³ã‚„å‚åŠ è€…ã® ID ä¸€è¦§ãªã©](https://storage.googleapis.com/zenn-user-upload/ssyjh3kx1rbq4i7bjdsczgpw162w)

## ä½œã£ã¦ã¿ã‚‹

ã‚¦ã‚§ãƒ–ç‰ˆï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ JavaScriptï¼‰ã§ã™ã€‚

### ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ

ã¾ãšã¯ Agora ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ã€ãƒ‡ãƒ¢ã‚¢ãƒ—ãƒªç”¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚ç„¡æ–™ã§ã™ã€‚

- [Agora.io Signup](https://sso.agora.io/en/v2/signup)

å¾Œã§å¿…è¦ãªæƒ…å ±ã‚’å–ã‚Šã«æˆ»ã£ã¦ãã¾ã™ã€‚

:::details ã‚‚ã†ã¡ã‚‡ã£ã¨
åˆå›ã¯ãªã‹ã£ãŸæ°—ãŒã™ã‚‹ã‚“ã ã‘ã©ã‚‚ã€ã‚‚ã—ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã®ã¨ã“ã‚ã§ Authentication Mechanism ã®é¸æŠãŒå‡ºã¦ããŸã‚‰ Secure mode ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚token ãªã—ã¯ã¡ã‚‡ã£ã¨ã“ã‚ã„ã§ã—ã‚‡ã€‚

![](https://storage.googleapis.com/zenn-user-upload/swkzssyf0cy642smnms17e58pmir)
*æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆç”»é¢ã€‚Testing mode ãªã‚‰ token ä¸è¦ã¨ã‚ã‚‹ã€‚*

Signup ã‹ã‚‰ã¯ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¿ãŸã„ãªæ„Ÿã˜ã§ã©ã‚“ã©ã‚“é€²ã‚€ã®ã§ç‰¹ã«ã¤ã¾ã¥ãã“ã¨ã‚‚ãªã„ã¨æ€ã†ã‘ã©ã€ã“ã¡ã‚‰ã®è¨˜äº‹ã«è©³ã—ãæ›¸ã„ã¦ã‚ã‚‹ã®ã‚’è¦‹ã‹ã‘ã¾ã—ãŸã®ã§è‰¯ã‘ã‚Œã°ä½µã›ã¦ã”è¦§ãã ã•ã„ã€‚

- [Clubhouseã‚‚ä½¿ã£ã¦ã„ã‚‹ã‚‰ã—ã„Agoraã‚’ä½¿ã£ã¦ç°¡å˜ã«ãƒ“ãƒ‡ã‚ªé€šè©±](https://zenn.dev/arahabica/articles/0f54f2cdb1a29d)
:::

### ã‚¢ãƒ—ãƒªã®éª¨çµ„ã¿ä½œæˆ

é©å½“ãª HTML ã‚’ç”¨æ„ã—ã¦ãã ã•ã„ã€‚ç”»é¢ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã§è¡¨ç¤ºã™ã‚‹ã¨ã“ã‚ã¾ã§ã§ããŸã‚‚ã®ã¨ã—ã¾ã™ã€‚

### SDK èª­ã¿è¾¼ã¿

ä»Šå›ã®ãƒ‡ãƒ¢ã§ã¯ç´ ã® JavaScript ã§æ›¸ãã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ã‚‚ [Browsersync](https://www.browsersync.io/) ãªã®ã§ã”ãå˜ç´”ãªæ§‹æˆã§ã™ã€‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã¯ CDN ã§é…ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã®ã§ã€å·®ã—å½“ãŸã‚Šã“ã„ã¤ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚

```html
<script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.3.0.js"></script>
```

ãŠå¥½ã¿ã§ React ãªã‚Šã¸æ··ãœã“ã‚“ã§ãã ã•ã£ã¦ã‚‚çµæ§‹ã€‚ãã®å ´åˆã¯ npm ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ–¹ã‚’ã©ã†ãã€‚

```bash
$ npm install agora-rtc-sdk-ng
```

```js
import AgoraRTC from "agora-rtc-sdk-ng"
```

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ç”¨æ„

ã“ã“ã‹ã‚‰å®Ÿè£…ã§ã™ã€‚

æœ€åˆã« Agora ã®ã‚µãƒ¼ãƒãƒ¼ã¸æ¥ç¶šã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

```js
const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
```

- [createClient(config: ClientConfig): IAgoraRTCClient](https://docs.agora.io/en/Voice/API%20Reference/web_ng/interfaces/iagorartc.html#createclient)

ã“ã®å…ˆã“ã® `client` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ã„ã¾ã‚ã™ã®ã§æŒã£ã¦ãŠã„ã¦ãã ã•ã„ã€‚

### ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³

åˆ©ç”¨è€…ã®æ“ä½œ 4 ç¨®ã¨ Agora ã‹ã‚‰ã®é€šçŸ¥ 4 ç¨®ã‚’å‡¦ç†ã—ã¾ã™ã€‚

åˆ©ç”¨è€…æ“ä½œã¯ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ HTML ã«ã”ç”¨æ„ãã ã•ã„ã€‚ãã‚“ã§ `button.onclick` ã¨ã‹ã€‚

- join - ãƒãƒ£ãƒ³ãƒãƒ«å‚åŠ 
- leave - ãƒãƒ£ãƒ³ãƒãƒ«é›¢è„±
- publish - éŸ³å£°é€ä¿¡é–‹å§‹ï¼ˆã‚¢ãƒ³ãƒŸãƒ¥ãƒ¼ãƒˆï¼‰
- unpublish - éŸ³å£°é€ä¿¡çµ‚äº†ï¼ˆãƒŸãƒ¥ãƒ¼ãƒˆï¼‰

Agora ã‹ã‚‰ã®é€šçŸ¥ã¯ `client.on()` ã§ç›£è¦–ã§ãã¾ã™ã€‚ä»¥ä¸‹ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

- `user-joined` - èª°ã‹ join ã—ãŸ
- `user-left` - èª°ã‹ leave ã—ãŸ
- `user-published` - èª°ã‹ publish ã—ãŸ
- `user-unpublished` - èª°ã‹ unpublish ã—ãŸ

ã¨ã„ã†ã‚ã‘ã§ã€ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®é–¢æ•°ã¯ã“ã‚Œã‹ã‚‰ä½œã£ã¦ã„ãã¾ã™ã€‚

```js
document.querySelector("#join").onclick = onJoinClick;
document.querySelector("#leave").onclick = onLeaveClick;
document.querySelector("#publish").onclick = onPublishClick;
document.querySelector("#unpublish").onclick = onUnpublishClick;

client.on("user-joined", onAgoraUserJoined);
client.on("user-left", onAgoraUserLeft);
client.on("user-published", onAgoraUserPublished);
client.on("user-unpublished", onAgoraUserUnpublished);
```

### ãƒãƒ£ãƒ³ãƒãƒ«å‚åŠ 

```js
async function onJoinClick() {
  const uid = await client.join(appId, channel, token, null);
}
```

- [join(appid: string, channel: string, token: string | null, uid?: UID | null): Promise<UID>](https://docs.agora.io/en/Voice/API%20Reference/web_ng/interfaces/iagorartcclient.html#join)

ã•ã¦ã“ã“ã§ 4 ã¤ã®å€¤ãŒå¿…è¦ã§ã™ã€‚Agora ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ« > [Project Management](https://console.agora.io/projects)ã‹ã‚‰æ¢ã—ã¦ãã¦ãã ã•ã„ã€‚

:::details å€¤ã®æ¢ã—æ–¹
- `appId` - "App ID" ã®ã‚„ã¤
- `channel` - ã“ã‚Œã¯ãŠå¥½ãã«ã€‚ç©ºç™½ã‚„è¨˜å·ã‚‚ä½¿ãˆã‚‹æ§˜å­ï¼ˆ`join()` API ã®ä»•æ§˜ã‚’å‚ç…§ï¼‰
- `token` - `channel` ãªã©ã‚’å…ƒã«ç”Ÿæˆã•ã‚Œã‚‹ã‚‚ã®
  - [Project Management](https://console.agora.io/projects) > Edit > Features > Generate temp token ã§ç”Ÿæˆ
  - é€šå¸¸ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆæ™‚ã« Secure mode ã‚’é¸æŠã™ã‚‹ã®ã§å®Ÿè³ªå¿…é ˆ
- `uid` - è‡ªå‹•ç”Ÿæˆã•ã›ã‚‹ã®ã§ `null`

ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆã®éš›ã¯åˆ©ç”¨ã™ã‚‹ãƒãƒ£ãƒ³ãƒãƒ«å `demo_channel_name` ã‚’æ­£ç¢ºã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ã“ã‚ŒãŒé£Ÿã„é•ã†ã¨ CAN_NOT_GET_GATEWAY_SERVER ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/482yx81mhogijn2so7drxray8tmm)
*Generate temp token ã®æ§˜å­ã€‚ãƒãƒ£ãƒ³ãƒãƒ«åã‚’å…¥åŠ›ã™ã‚‹ã€‚*

ãªãŠ `token` ã¯ã€ãƒ‡ãƒ¢ã§ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ç”Ÿæˆã§ããŸã‘ã©æœ¬ç•ªã§ã¯è‡ªåŠ›ã§ç”Ÿæˆã—ã¾ã™ã€‚ç§˜å¯†ã®æƒ…å ± App certificate ã‚’ç”¨ã„ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã§ã™ã€‚ã‚³ãƒ¼ãƒ‰ãŒéœ²å‡ºã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã¯è¡Œãˆã¾ã›ã‚“ã€‚ã‚µãƒ¼ãƒãƒ¼å´ã‹ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãªã‚„ã¤ã§ã‚„ã‚ã†ã€‚

- [Generate a Token](https://docs.agora.io/en/Voice/token_server?platform=All%20Platforms)
  - ã„ããªã‚Š C++ ã®ã‚³ãƒ¼ãƒ‰ãŒå‡ºã¦ãã‚‹ã‘ã©çˆ½ã‚„ã‹ã«ã‚¹ãƒ«ãƒ¼ã—ã¦ Node.js ã‚’æ¢ã—ã¦ãã ã•ã„
- å…¬å¼ã‚µãƒ³ãƒ—ãƒ«ï¼š[Tools/RtcTokenBuilderSample.js at master Â· AgoraIO/Tools](https://github.com/AgoraIO/Tools/blob/master/DynamicKey/AgoraDynamicKey/nodejs/sample/RtcTokenBuilderSample.js)
- App certificate ã¨ App Secret ã¯åŒã˜ã‚‚ã®ã‚’æŒ‡ã™æ§˜å­
:::

### ãƒãƒ£ãƒ³ãƒãƒ«é›¢è„±

`client.localAudioTrack` ã¯é…åˆ—ã§ã€å¾Œã® publish æ™‚ã«å¢—ãˆã¾ã™ã€‚

```js
async function onLeaveClick() {
  // éŸ³å£°ã®ãƒˆãƒ©ãƒƒã‚¯ã‚’é–‰ã˜ã‚‹ï¼ˆå¿…é ˆï¼‰
  client.localTracks.forEach((v) => v.close());

  await client.leave();
}
```

- [localTracks: ILocalTrack[]](https://docs.agora.io/en/Voice/API%20Reference/web_ng/interfaces/iagorartcclient.html#localtracks)
- [close(): void](https://docs.agora.io/en/Voice/API%20Reference/web_ng/interfaces/imicrophoneaudiotrack.html#close)
- [leave(): Promise<void>](https://docs.agora.io/en/Voice/API%20Reference/web_ng/interfaces/iagorartcclient.html#leave)

éŸ³å£°ã®ãƒˆãƒ©ãƒƒã‚¯ã¯æ¬¡ã® `onPublishClick()` ã§ä½œæˆã—ã¾ã™ã€‚

[é›¢è„±æ™‚ã«ã“ã®éŸ³å£°ã®ãƒˆãƒ©ãƒƒã‚¯ã‚’é–‰ã˜ã‚‹ã®ã¯å¿…é ˆ](https://docs.agora.io/en/Voice/start_call_audio_web_ng?platform=Web#5-leave-the-channel)ã¨ã®ã“ã¨ã€‚ï¼ˆã§ã‚‚ä»£ã‚ã‚Šã« `client.unpublish()` ã§ã‚‚è‰¯ã•ãã†ï¼Ÿï¼‰ï¼ˆã—ãªã‹ã£ãŸã‚‰ã©ã†ãªã‚‹ã‚“ã ã‚ã†ï¼Ÿï¼‰ï¼ˆAPI ã®èª¬æ˜ã«è¨˜è¼‰ãŒãªã„ï¼Ÿï¼‰

> Destroying the local media tracks is mandatory. You can follow your own implementation preferences.

ã“ã‚Œã§å‚åŠ ã¨é›¢è„±ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚èãå°‚ãªã‚‰ã“ã‚Œã§çµ‚ã‚ã‚Šã€‚

### éŸ³å£°é€ä¿¡é–‹å§‹

å–‹ã‚Šå§‹ã‚ã¾ã™ã€‚

```js
async function onPublishClick() {
  const localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
  await client.publish([localAudioTrack]);
}
```

- [createMicrophoneAudioTrack(config?: MicrophoneAudioTrackInitConfig): Promise<IMicrophoneAudioTrack>](https://docs.agora.io/en/Voice/API%20Reference/web_ng/interfaces/iagorartc.html#createmicrophoneaudiotrack)
- [publish(tracks: ILocalTrack | ILocalTrack[]): Promise<void>](https://docs.agora.io/en/Voice/API%20Reference/web_ng/interfaces/iagorartcclient.html#publish)

### éŸ³å£°é€ä¿¡çµ‚äº†

è‡ªèº«ã®éŸ³å£°ã‚’ãƒŸãƒ¥ãƒ¼ãƒˆã—ã¾ã™ã€‚

```js
async function onUnpublishClick() {
  await client.unpublish();
}
```

- [unpublish(tracks?: ILocalTrack | ILocalTrack[]): Promise<void>](https://docs.agora.io/en/Voice/API%20Reference/web_ng/interfaces/iagorartcclient.html#unpublish)

ã¡ãªã¿ã«éŸ³å£°ãƒˆãƒ©ãƒƒã‚¯ã¯ `publish()` ã§è¤‡æ•°ç™»éŒ²ã§ãã¦ã€`unpublish()` ã®å¼•æ•°ã§æŒ‡å®šã—ã¦ä»»æ„ã®ã‚‚ã®ã‚’é–‰ã˜ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã§ã™ã€‚ã¾ãŸçœç•¥ã™ã‚‹ã¨å…¨ã¦é–‰ã˜ã‚‹ã¨ã®ã“ã¨ã€‚`leave()` ã¨ã®é–¢ä¿‚ã¯ã©ã‚“ãªæ„Ÿã˜ãªã‚“ã ã‚ï¼Ÿ

ã¾ã‚ã¨ã‚‚ã‹ãã“ã‚Œã§è‡ªèº«ã®æ“ä½œã¯ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ã“ã“ã‹ã‚‰ã¯ä»–ã®äººã®éŸ³å£°ã‚’å–å¾—ã—ã¦ã„ãã¾ã™ã€‚

### èª°ã‹ join ã—ãŸ

å‚åŠ è€…ä¸€è¦§ã«è¡¨ç¤ºã™ã‚‹ã¨ã‹ã—ã¦ãã ã•ã„ã€‚ï¼ˆå®Ÿéš›ãƒ‡ãƒ¢ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã“ã“ã§æ›´æ–°ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚ï¼‰

```js
// client.on("user-joined", onAgoraUserJoined);

async function onAgoraUserJoined(user) {
}
```

- [user-joined(user: IAgoraRTCRemoteUser): void](https://docs.agora.io/en/Voice/API%20Reference/web_ng/interfaces/iagorartcclient.html#event_user_joined)
- [IAgoraRTCRemoteUser](https://docs.agora.io/en/Voice/API%20Reference/web_ng/interfaces/iagorartcremoteuser.html)

[`user: IAgoraRTCRemoteUser`](https://docs.agora.io/en/Voice/API%20Reference/web_ng/interfaces/iagorartcremoteuser.html) ã¯ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã¡ã¾ã™ã€‚

- `audioTrack`
- `hasAudio`
- `hasVideo`
- `uid`
- `videoTrack`

äººã®åå‰ã‚„ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒãªã‚“ã‹ã¯ Agora ã®è²¬å‹™ã®ç¯„å›²å¤–ãªã®ã§è‡ªå‰ã§åå¯„ã›ã—ã¦ãã ã•ã„ã€‚ã“ã“ã® `user.uid` ã¯ãã®äººã® `client.join()` ã®æˆ»ã‚Šå€¤ã¨åˆè‡´ã™ã‚‹ã®ã§ã€å‚åŠ æ™‚ã« Redis ã¸ç½®ãã¨ã‹ã€‚

### èª°ã‹ leave ã—ãŸ

```js
// client.on("user-left", onAgoraUserLeft);

async function onAgoraUserLeft(user, reason) {
}
```

- [user-left(user: IAgoraRTCRemoteUser, reason: string): void](https://docs.agora.io/en/Voice/API%20Reference/web_ng/interfaces/iagorartcclient.html#event_user_left)

`reason` ã¯ä»¥ä¸‹ã® 3 ç¨®ã€‚

- `"Quit"` - é›¢è„±ã—ãŸ
- `"ServerTimeOut"` - ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã«ãªã£ãŸ
- `"BecomeAudience"` - *role* ãŒ audience ã«ãªã£ãŸ

[*role*](https://docs.agora.io/en/Voice/API%20Reference/web_ng/globals.html#clientrole) ã¯æœ¬ç¨¿ã§ã¯æ‰±ã£ã¦ã„ã¾ã›ã‚“ã€‚

### èª°ã‹ publish ã—ãŸ

è©±ã—å§‹ã‚ãŸã®ã§å‚¾è´ã—ã¾ã™ã€‚

```js
// client.on("user-published", onAgoraUserPublished);

async function onAgoraUserPublished(user, mediaType) {
  const track = await client.subscribe(user, mediaType);
  track.play();
}
```

- [user-published(user: IAgoraRTCRemoteUser, mediaType: "audio" | "video"): void](https://docs.agora.io/en/Voice/API%20Reference/web_ng/interfaces/iagorartcclient.html#event_user_published)
- [subscribe(user: IAgoraRTCRemoteUser, mediaType: "audio"): Promise<IRemoteAudioTrack>](https://docs.agora.io/en/Voice/API%20Reference/web_ng/interfaces/iagorartcclient.html#subscribe)
- [RemoteAudioTrack](https://docs.agora.io/en/Voice/API%20Reference/web_ng/interfaces/iremoteaudiotrack.html)
- [play(): void](https://docs.agora.io/en/Voice/API%20Reference/web_ng/interfaces/iremoteaudiotrack.html#play)

### èª°ã‹ unpublish ã—ãŸ

```js
// client.on("user-unpublished", onAgoraUserUnpublished);

async function onAgoraUserUnpublished(user, mediaType) {
}
```

- [user-unpublished(user: IAgoraRTCRemoteUser, mediaType: "audio" | "video"): void](https://docs.agora.io/en/Voice/API%20Reference/web_ng/interfaces/iagorartcclient.html#event_user_unpublished)

ç‰¹ã« `close()` ãªã©éŸ³å£°ãƒˆãƒ©ãƒƒã‚¯ã‚’æ“ä½œã™ã‚‹å¿…è¦ã¯ãªã„ã¿ãŸã„ã§ã™ã€‚

ã¡ãªã¿ã«ã“ã“ã€ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã ã¨è¬ã« `<div>` ã‚’å‰Šé™¤ã—ã‚ˆã†ã¨ã—ã¦ã‚‹ã‚“ã ã‘ã©ãã‚“ãªã‚‚ã®ä½œã£ã¦ãªã„ã—ç¢ºèªã‚‚ã—ã¦ã„ãªã„ã®ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚ãªã‚“ã ã‚ã€å¤ã„ API ã§ã¯ãã†ã„ã†ä½œæ¥­ãŒã‚ã£ãŸã®ã‹ãªï¼Ÿ

ã¨ã‚‚ã‹ãã“ã‚Œã§äººã®å£°ã‚‚èã“ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã€éŸ³å£°ãƒãƒ£ãƒƒãƒˆãŒå®Œæˆã—ã¾ã—ãŸã€‚ã‚„ã£ãŸã­ã€‚

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ç”»é¢èª­ã¿è¾¼ã¿æ™‚ã®ã‚¨ãƒ©ãƒ¼

> AgoraRTCError NOT_SUPPORTED: enumerateDevices() not supported.

> AgoraRTCError WEB_SECURITY_RESTRICT: Your context is limited by web security, please try using https protocol or localhost.

â†’ `localhost` ã‚ã‚‹ã„ã¯ `https://` ã® URL ã§é–‹ã„ã¦ãã ã•ã„ã€‚`http://` ã§ã“ã®ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

### ãƒãƒ£ãƒ³ãƒãƒ«å‚åŠ æ™‚ã®ã‚¨ãƒ©ãƒ¼

> AgoraRTCException
> AgoraRTCError CAN_NOT_GET_GATEWAY_SERVER: dynamic use static key

â†’ `token` ã‚’ `null` ã«ã›ãšã€æ–‡å­—åˆ—ã‚’ä¸ãˆã‚‹ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯ `string | null` ã¨ã‚ã‚‹ãŒå®Ÿè³ªå¿…é ˆã€‚

> AgoraRTCError INVALID_PARAMS: Invalid token: . If you don not use token, set it to null

â†’ `secrets.js` ã§ `token` ã‚’è¨­å®šã™ã‚‹ã€‚ç©ºæ–‡å­—åˆ—ã®ã¾ã¾ã«ãªã£ã¦ã„ã‚‹ã€‚

> Choose server https://webrtc2-ap-web-1.agora.io/api/v1 failed, message: AgoraRTCError CAN_NOT_GET_GATEWAY_SERVER: dynamic key expired, retry: false

â†’ `token` ã‚’å†ç”Ÿæˆã™ã‚‹ã€‚æœŸé™åˆ‡ã‚Œã€‚24 æ™‚é–“ç¨‹åº¦ï¼Ÿ

> AgoraRTCError CAN_NOT_GET_GATEWAY_SERVER: invalid token, authorized failed

â†’ `token` ãŒæ­£ã—ã„ãƒãƒ£ãƒ³ãƒãƒ«åã§ç”Ÿæˆã•ã‚ŒãŸã‹ç¢ºèªã™ã‚‹ã€‚

### `token` ã‚’å–å¾—ã™ã‚‹ã«ã¯

ã“ã¡ã‚‰ï¼š

- [Project Management](https://console.agora.io/projects) > Edit > Features > Generate temp token

ã‚ã‚‹ã„ã¯ã“ã¡ã‚‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«å¾“ã£ã¦ãã ã•ã„ï¼š [Generate a Token](https://docs.agora.io/en/Voice/token_server?platform=All%20Platforms)

### éŸ³å£°é€ä¿¡é–‹å§‹æ™‚ã®ã‚¨ãƒ©ãƒ¼

> AgoraRTCError INVALID_OPERATION: Can't publish stream, haven't joined yet!

â†’ å…ˆã« `client.join()` ã‚’å‘¼ã¶ã€‚

### èª°ã‹ãŒ leave ã—ãŸã¨ãã®ã‚¨ãƒ©ãƒ¼

> TypeError: Cannot read property 'remove' of null

â†’ è¦ç´ ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ `document.getElementById(user.uid)` ã®çµæœã®è¦ç´ ã‚’å‰Šé™¤ã—ã‚ã¨è¨€ã†ã‚“ã ã‘ã©ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¢ã—ã¦ã‚‚ãã‚“ãªã‚‚ã®ã¯ä½œã‚‰ã‚Œã¦ã„ãªã„ã‚“ã ã‚ˆãªã‚ã€‚

## ãŠã—ã¾ã„

ã“ã‚Œã§ Clubhouse ã‚¯ãƒ­ãƒ¼ãƒ³ãŒä½œã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ã‚ã¨ã¯ãƒ­ã‚°ã‚¤ãƒ³åˆ¶å¾¡ã¨ã‹ã—ã¦ã€è‰¯ã„æ„Ÿã˜ã« UI ã‚’æ•´ãˆãŸã‚‰è‰¯ã•ãã†ã§ã™ã€‚Agora ç°¡å˜ã ã—ç„¡æ–™æ ã‚‚ãªã‹ãªã‹ã‚ã‚‹ã®ã§ã€åˆ¥ã®ã‚¢ãƒ—ãƒªã«çµ„ã¿è¾¼ã‚“ã§ã‚‚ãŠã‚‚ã—ã‚ã„ã‹ã‚‚ã€‚æ˜ åƒã®æ–¹ã‚‚ã€‚

å›ã ã‘ã®æœ€å¼·ã® Clubhouse ã‚’ä½œã‚ã†ï¼

### å‚è€ƒ

- [Agora Developer Center](https://docs.agora.io/en/Voice/landing-page?platform=Web)
- [Start a Voice Call](https://docs.agora.io/en/Voice/start_call_audio_web_ng?platform=Web) - å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«
- [Clubhouse ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é…ä¿¡ã®ä»•çµ„ã¿ã«ã¤ã„ã¦](https://zenn.dev/voluntas/scraps/9403b803320d6f)
- [Clubhouseã‚‚ä½¿ã£ã¦ã„ã‚‹ã‚‰ã—ã„Agoraã‚’ä½¿ã£ã¦ç°¡å˜ã«ãƒ“ãƒ‡ã‚ªé€šè©±](https://zenn.dev/arahabica/articles/0f54f2cdb1a29d)

[^1]: https://ja.wikipedia.org/wiki/%E3%81%99%E3%81%A3%E3%81%B1%E3%81%84%E8%91%A1%E8%90%84
